#!/bin/sh

set -e
if [ "$1" = "configure" ]
	then
        if [ -d /usr/doc -a ! -e /usr/doc/dtc -a -d /usr/share/doc/dtc ]
	then
                ln -sf ../share/doc/dtc /usr/doc/dtc
        fi
fi


# Debian install bash script for DTC
# Written by Thomas GOIRAND <thomas@goirand.fr>
# under LGPL Licence

# exit 0

UNIX_TYPE=debian

PATH_HTTPD_CONF=/etc/apache/httpd.conf
PATH_HTTPD_MODULES_CONF=/etc/apache/modules.conf
PATH_NAMED_CONF=/etc/bind/named.conf
PATH_QMAIL_CTRL=/etc/qmail
PATH_PHP_CGI="/usr/bin/php4"
PATH_PROFTPD_CONF=/etc/proftpd.conf
PATH_DOVECOT_CONF=/etc/dovecot.conf
PATH_COURIER_CONF_PATH=/etc/courier
PATH_POSTFIX_CONF=/etc/postfix/main.cf
PATH_DTC_SHARED=/usr/share/dtc

PATH_DTC_ETC=$PATH_DTC_SHARED"/etc"
PATH_DTC_ADMIN=$PATH_DTC_SHARED"/admin"
PATH_DTC_CLIENT=$PATH_DTC_SHARED"/client"

# Source debconf library -- we have a Depends line
# to make sure it is there...
. /usr/share/debconf/confmodule
db_version 2.0

# Simply fetch all values stored in debconf
db_get dtc/conf_mysqlhost
conf_mysql_host=$RET
db_get dtc/conf_mysqllogin
conf_mysql_login=$RET
db_get dtc/conf_mysqlpass
conf_mysql_pass=$RET
db_get dtc/conf_mysqldb
conf_mysql_db=$RET
db_get dtc/conf_mysql_change_root
conf_mysql_change_root=$RET
db_get dtc/conf_mta_type
conf_mta_type=$RET
db_get dtc/main_domainname
main_domain_name=$RET
db_get dtc/dtc_adminsubdomain
dtc_admin_subdomain=$RET
db_get dtc/conf_ipaddr
conf_ip_addr=$RET
db_get dtc/conf_hostingpath
conf_hosting_path=$RET
db_get dtc/conf_chroot_path
conf_chroot_path=$RET
db_get dtc/conf_hostingpath
conf_hosting_path=$RET
db_get dtc/conf_admlogin
conf_adm_login=$RET
db_get dtc/conf_admpass
conf_adm_pass=$RET

db_unregister dtc/conf_mysqlpass
db_unregister dtc/conf_mysql_change_root
db_unregister dtc/conf_admpass
# db_purge

# This part is debian specific because of (in my point of view) some
# leak in distribution. Whis is that not made by default ?

# Adding support for mysql for php4-cgi
echo "Checking mysql.so in php.ini"
if grep mysql.so /etc/php4/cgi/php.ini | grep extension=
then
	echo "Skiping mysql.so insertion in php.ini"
else
	echo "Your php.ini doesn't has mysql extension: DTC will add it !"
	echo "extension=mysql.so" >>/etc/php4/cgi/php.ini
fi

# Setup a minimum include path with . and /usr/share/pear (or /usr/share/php for debian testing) !!!
if [ -f /usr/share/pear/PEAR.php ]
then
	echo "Checking include_path=/usr/share/pear in php.ini"
	if grep include_path /etc/php4/cgi/php.ini | grep /usr/share/pear
	then
		echo "Skiping include_path insertion in php.ini"
	else
		echo "Your php.ini doesn't has pear in it's inc path: changin!"
		echo "include_path = \".:/usr/share/pear\"" >>/etc/php4/cgi/php.ini
	fi
fi

if [ -f /usr/share/php/PEAR.php ]
then
	echo "Checking include_path=/usr/share/pear in php.ini"
	if grep include_path /etc/php4/cgi/php.ini | grep /usr/share/php
	then
		echo "Skiping include_path insertion in php.ini"
	else
		echo "Your php.ini doesn't has pear in it's inc path: changin!"
		echo "include_path = \".:/usr/share/php\"" >>/etc/php4/cgi/php.ini
	fi

fi

# Do a test to check php version. Those fucking PHP guys had
# made things so simple that this test is not very short... :(
CNT=`/usr/bin/php4 -v | wc -l`
if [ $CNT -ge 2 ] ; then
	PHPVER=`/usr/bin/php4 -v | head -n 1 | cut -f2 -d" "`
else
	PHPVER=`/usr/bin/php4 -v`
fi
PHPMAJOR=`echo $PHPVER | cut -f1 -d"."`
PHPMINOR=`echo $PHPVER | cut -f2 -d"."`

echo "The installer has detected PHP version "$PHPMAJOR" release $PHPMINOR"

# now update the pear modules if you have the "pear" installed
# since PHP >= 4.3.0 doesn't come with Crypt_CBC that OpenSRS needs
if [ ""$TMP = "" ]; then
	TMP=/tmp
fi
if [ $PHPMAJOR -ge 4 -a $PHPMINOR -ge 3 -a -e /usr/bin/pear ]
then
	echo "Checking pear installation for PHP > 4.3"
	/usr/bin/pear upgrade Console_Getopt > $TMP/pear.install
	/usr/bin/pear upgrade-all >> $TMP/pear.install
	/usr/bin/pear install Crypt_CBC >> $TMP/pear.install
	/usr/bin/pear install Auth_SASL >> $TMP/pear.install
else
	echo "This is a version of PHP that should have the modules included"
fi

# Changing root password of mysql
if [ $conf_mysql_change_root == true ]
then
	echo "===> Changing MySQL root password"
	echo "If you didn't setup a root pass for mysqld, just hit ENTER."
	mysql -u$conf_mysql_login -p -h$conf_mysql_host -Dmysql --execute="UPDATE user SET Password=PASSWORD('"$conf_mysql_pass"') WHERE User='root'; FLUSH PRIVILEGES;"
fi

if grep "nameserver 127.0.0.1" /etc/resolv.conf
then
	echo "/etc/resolv.conf seems to be OK !"
else
	if grep "// forwarders" /etc/bind/named.conf
	then
		echo "!!! WARNING !!! Edit your named forwarders conf in /etc/bind/named.conf NOW !!!"
	fi

	echo "Adding nameserver 127.0.0.1 to /etc/resolv.conf"
	grep "search" /etc/resolv.conf >/tmp/DTC_resolv.conf
	echo "nameserver 127.0.0.1" >>/tmp/DTC_resolv.conf
	grep "nameserver" /etc/resolv.conf >>/tmp/DTC_resolv.conf
	cat </tmp/DTC_resolv.conf >/etc/resolv.conf
	rm /tmp/DTC_resolv.conf
fi

# Upon this line, here is the standard DTC install script :
