#!/bin/sh

set -e
if [ "$1" = "configure" ]
	then
        if [ -d /usr/doc -a ! -e /usr/doc/dtc -a -d /usr/share/doc/dtc ]
	then
                ln -sf ../share/doc/dtc /usr/doc/dtc
        fi
fi


# Debian install bash script for DTC
# Written by Thomas GOIRAND <thomas@goirand.fr>
# under LGPL Licence

# exit 0

UNIX_TYPE=debian

PATH_HTTPD_CONF=/etc/apache/httpd.conf
PATH_NAMED_CONF=/etc/bind/named.conf
PATH_QMAIL_CTRL=/etc/qmail
PATH_PHP_CGI="/usr/bin/php4"
PATH_PROFTPD_CONF=/etc/proftpd.conf
PATH_DTC_SHARED=/usr/share/dtc

PATH_DTC_ETC=$PATH_DTC_SHARED"/etc"
PATH_DTC_ADMIN=$PATH_DTC_SHARED"/admin"
PATH_DTC_CLIENT=$PATH_DTC_SHARED"/client"

# Source debconf library -- we have a Depends line
# to make sure it is there...
. /usr/share/debconf/confmodule
db_version 2.0

# Simply fetch all values stored in debconf
db_get dtc/conf_mysqlhost
conf_mysql_host=$RET
db_get dtc/conf_mysqllogin
conf_mysql_login=$RET
db_get dtc/conf_mysqlpass
conf_mysql_pass=$RET
db_get dtc/conf_mysqldb
conf_mysql_db=$RET
db_get dtc/conf_mysql_change_root
conf_mysql_change_root=$RET
db_get dtc/main_domainname
main_domain_name=$RET
db_get dtc/dtc_adminsubdomain
dtc_admin_subdomain=$RET
db_get dtc/conf_ipaddr
conf_ip_addr=$RET
db_get dtc/conf_hostingpath
conf_hosting_path=$RET
db_get dtc/conf_hostingpath
conf_hosting_path=$RET
db_get dtc/conf_admlogin
conf_adm_login=$RET
db_get dtc/conf_admpass
conf_adm_pass=$RET

db_unregister dtc/conf_mysqlpass
db_unregister dtc/conf_mysql_change_root
db_unregister dtc/conf_admpass
# db_purge

# This part is debian specific because of (in my point of view) some
# leak in distribution. Whis is that not made by default ?

# Adding support for mysql for php4-cgi
if grep mysql.so /etc/php4/cgi/php.ini | grep extention=
then
	echo "Skiping mysql.so insertion in php.ini"
else
	echo "Your php.ini doesn't has mysql extention: DTC will add it !"
	echo "extention=mysql.so" >>/etc/php4/cgi/php.ini
fi

# Setup a minimum include path with . and /usr/share/pear !!!
if grep include_path /etc/php4/cgi/php.ini | grep /usr/share/pear
then
	echo "Skiping include_path insertion in php.ini"
else
	echo "Your php.ini doesn't has pear in it's inc path: changin!"
	echo "include_path = \".:/usr/share/pear\"" >>/etc/php4/cgi/php.ini
fi

# Changing root password of mysql
if [ $conf_mysql_change_root = true ]
then
	echo "===> Changing MySQL root password"
	echo "If you didn't setup a root pass for mysqld, just hit ENTER."
	mysql -u$conf_mysql_login -p -h$conf_mysql_host -Dmysql --execute="UPDATE user SET Password=('"$conf_mysqlpass"') WHERE User='root'; FLUSH PRIVILEGES;"
fi

# Configurating apache
if grep "User nobody" /etc/apache/httpd.conf
then
	echo "Skiping httpd.conf configuration"
else
	echo "===> Configurating httpd.conf"
	grep -v "User www-user" /etc/apache/httpd.conf >/tmp/httpd.conf_DTC
	grep -v "Group www-group" /tmp/httpd.conf_DTC >/tmp/httpd.conf_DTC2
	cat </tmp/httpd.conf_DTC2 >/etc/apache/httpd.conf
	rm /tmp/httpd.conf_DTC /tmp/httpd.conf_DTC2
	echo "# DTC HTTPD Config start
User nobody
Group nogroup
Listen 80
Listen 443
LoadModule php4_module /usr/lib/apache/1.3/libphp4.so
LoadModule ssl_module /usr/lib/apache/1.3/mod_ssl.so

LogSQLLoginInfo localhost "$conf_mysql_login" "$conf_mysql_pass"
LogSQLSocketFile /var/run/mysqld/mysqld.sock
LogSQLDatabase apachelogs
LogSQLCreateTables On
LogSQLTransferLogFormat IAbhRrSsU
# DTC HTTPD Config end" >>/etc/apache/httpd.conf
fi

if grep "nameserver 127.0.0.1" /etc/resolv.conf
then
	echo "/etc/resolv.conf seems to be OK !"
else
	if grep "// forwarders" /etc/bind/named.conf
	then
		echo "Edit your named forwarders conf in /etc/bind/named.conf NOW !!!"
	fi

	echo "Adding nameserver 127.0.0.1 to /etc/resolv.conf"
	grep "search" /etc/bind/named.conf >/tmp/DTC_resolv.conf
	echo "nameserver 127.0.0.1" >>/tmp/DTC_resolv.conf
	grep "nameserver" >/tmp/DTC_resolv.conf
	cat </tmp/DTC_resolv.conf >/etc/bind/named.conf
fi

# Upon this line, here is the standard DTC install script :
