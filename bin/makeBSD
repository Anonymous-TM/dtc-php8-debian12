#!/bin/sh
#
# Welcome to the DTC install maker !
# This will produce the tarball package
# Maintainer: Thomas GOIRAND <thomas [ at ] goirand.fr>
# please do not ship with you packages
# this is only a small coder tool...
#

VERS=`cat version`
RELS=`cat release`
VERSION=$VERS"."$RELS
UNIX_TYPE=bsd
PKG_BUILD="dtc-"$VERSION
PORT_BUILD=dtcBSDportBuild
ARCH_NAME=$PKG_BUILD".tar.gz"

./buildRelease $UNIX_TYPE $PKG_BUILD

kernel=`uname -a | awk '{print $1}'`;

echo "<?php
\$conf_dtc_version= \""$VERS"\";
\$conf_dtc_release= \""$RELS"\";
\$conf_unix_type= \""$UNIX_TYPE"\";
\$conf_kernel_type= \""$kernel"\";
?>" > $PKG_BUILD/shared/dtc_version.php

chown -R root:0 $PKG_BUILD
chown nobody:65534 $PKG_BUILD/client/imgcache $PKG_BUILD/admin/imgcache $PKG_BUILD/shared/imgcache $PKG_BUILD/email/imgcache
chown nobody:65534 $PKG_BUILD/client/gfx $PKG_BUILD/admin/gfx $PKG_BUILD/shared/gfx $PKG_BUILD/email/gfx
chown nobody:65534 $PKG_BUILD/admin/*.cgi

# Specific BSD package actions :
echo "all:" >$PKG_BUILD"/Makefile"
echo "===> Packaging files"
tar -czf $ARCH_NAME $PKG_BUILD

echo " --- Succesfully made BSD $ARCH_NAME ---"
echo " --- Making BSD port for version "$VERSION" ---"

# Move bsd version as if it was in ${PREFIX} so we can do lookups in it

echo "===> Creating port files"
# Make  dtc port dir and copy static files in it
mkdir -p $PORT_BUILD/files
cp sources/bsd/pkg-descr $PORT_BUILD
# Create Makefile with correct port version
echo "# Ports collection makefile for:        dtc
# Date created:                 1 December 2003
# Whom:                         Frederic Cambus & Thomas Goirand
#
# \$FreeBSD\$
#

PORTNAME=	dtc
PORTVERSION=	"$VERSION >$PORT_BUILD/Makefile
cat sources/bsd/Makefile >>$PORT_BUILD/Makefile

# Create package install script
cp sources/bsd/install.sh $PORT_BUILD/files/dtc-install.in
cat sources/setup_mysql_db.sh >>$PORT_BUILD/files/dtc-install.in
cat sources/create_chroot.sh >>$PORT_BUILD/files/dtc-install.in
cat sources/configure_deamons.sh >>$PORT_BUILD/files/dtc-install.in
chmod 644 $PORT_BUILD/files/dtc-install.in

# Create package uninstall script
cp sources/bsd/uninstall.sh $PORT_BUILD/files/dtc-deinstall.in
cat sources/uninstall_deamons.sh >>$PORT_BUILD"/files/dtc-deinstall.in"
chmod 644 $PORT_BUILD/files/dtc-deinstall.in

cp sources/bsd/pkg-message $PORT_BUILD

echo "===> Calculating package MD5 sum"
# Make the md5 sum file in this distinfo
SIZE=`ls -ALln "dtc-"$VERSION".tar.gz" | awk '{print $5}'`
# If /sbin/md5, assume it's the BSD md5 binary, otherwise use the one in /usr/bin/md5sum
if [ -e /sbin/md5 ] ; then
	md5 "dtc-"$VERSION".tar.gz" >>$PORT_BUILD/distinfo
	echo "SIZE (dtc-"$VERSION".tar.gz) = "$SIZE >>$PORT_BUILD/distinfo
else
	BSDSUM=`md5sum "dtc-"$VERSION".tar.gz" | cut -f1 -d" "`
	echo "MD5 (dtc-"$VERSION".tar.gz) = "$BSDSUM"
SIZE (dtc-"$VERSION".tar.gz) = "$SIZE >>$PORT_BUILD/distinfo
fi


echo "===> Creating package list file"
# Make the pkg-plist file
mkdir -p share/dtc
cp -rf $PKG_BUILD/* share/dtc

find share -type f >$PORT_BUILD/pkg-plist.tmp
echo "share/dtc/admin/gfx
share/dtc/admin/imgcache
share/dtc/shared/mysql_config.php
share/dtc/client/gfx
share/dtc/client/imgcache
sbin/dtc-install
sbin/dtc-deinstall" >>$PORT_BUILD/pkg-plist.tmp
find share -type d -printf "@dirrm %h/%f\n" | grep -v "share/dtc/etc" | sort -r >>$PORT_BUILD/pkg-plist.tmp
NBR_LINE=`cat $PORT_BUILD/pkg-plist.tmp | wc -l`
cat $PORT_BUILD/pkg-plist.tmp | head -n $(($NBR_LINE - 2 )) >$PORT_BUILD/pkg-plist.tmp2
sed "s/share\/dtc/%%DTCROOT%%/" $PORT_BUILD/pkg-plist.tmp2 | grep -v "mysql_config.php" >$PORT_BUILD/pkg-plist
echo "@dirrm %%DTCROOT%%/etc/zones
@dirrm %%DTCROOT%%/etc
@dirrm %%DTCROOT%%" >>$PORT_BUILD/pkg-plist
rm $PORT_BUILD/pkg-plist.tmp $PORT_BUILD/pkg-plist.tmp2
rm -r share

mkdir sysutils
mv $PORT_BUILD sysutils/dtc
# Those are slave ports, and is to be activatd in case of changes inside DTC's needs

#mkdir -p lang/php4-dtc
#cp sources/bsd/php4-dtc-slave lang/php4-dtc/Makefile
#mkdir -p ftp/proftpd-mysql
#cp sources/bsd/proftpd-dtc-slave ftp/proftpd-mysql/Makefile

echo "===> Creating .uue archive file"
# Make the file archive
tar -czf "dtcBSDport-"$VERSION".tar.gz" sysutils
uuencode "dtcBSDport-"$VERSION".tar.gz" dtc.tgz >"dtcBSDport-"$VERSION".uue"

echo "===> Creating send-pr file"
cp sources/bsd/sendpr.template sendpr.data
cat "dtcBSDport-"$VERSION".uue" >>sendpr.data
