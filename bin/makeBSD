#!/bin/sh
#
# Welcome to the DTC install maker !
# This will produce the tarball package
# Maintainer: Thomas GOIRAND <thomas [ at ] goirand.fr>
# please do not ship with you packages
# this is only a small coder tool...
#

VERS=`cat version`
RELS=`cat release`
VERSION=$VERS"."$RELS
UNIX_TYPE=bsd
PKG_BUILD="dtc-"$VERSION
PORT_BUILD=sysutils/dtc
ARCH_NAME=$PKG_BUILD".tar.gz"

CURDIR=`pwd`

# Specific BSD package actions :
# Create an empty Makefile in the "sources" of DTC so nothing is to be built
echo "===> Packaging files"
cd ..
tar -czf bin/$ARCH_NAME admin client doc email etc Makefile shared
cd $CURDIR

echo " --- Succesfully made BSD $ARCH_NAME ---"
echo " --- Making BSD port for version "$VERSION" ---"

# Move bsd version as if it was in ${PREFIX} so we can do lookups in it

echo "===> Creating port files"
# Make  dtc port dir and copy static files in it
mkdir -p $PORT_BUILD/files
cp sources/bsd/pkg-descr $PORT_BUILD
# Create Makefile with correct port version
echo "# Ports collection makefile for:        dtc
# Date created:                 1 December 2003
# Whom:                         Frederic Cambus & Thomas Goirand & Marc G. Fournier
#
# \$FreeBSD\$
#

PORTNAME=	dtc
PORTVERSION=	"$VERSION >$PORT_BUILD/Makefile
cat sources/bsd/Makefile >>$PORT_BUILD/Makefile

# Create package install script
cp sources/bsd/install.sh $PORT_BUILD/files/dtc-install.in
chmod 644 $PORT_BUILD/files/dtc-install.in

# Create package uninstall script
cp sources/bsd/uninstall.sh $PORT_BUILD/files/dtc-deinstall.in
#cat sources/uninstall_deamons.sh >>$PORT_BUILD"/files/dtc-deinstall.in"
chmod 644 $PORT_BUILD/files/dtc-deinstall.in

cp sources/bsd/pkg-message $PORT_BUILD

echo "===> Calculating package MD5 sum"
# Make the md5 sum file in this distinfo
SIZE=`ls -ALln "dtc-"$VERSION".tar.gz" | awk '{print $5}'`
# If /sbin/md5, assume it's the BSD md5 binary, otherwise use the one in /usr/bin/md5sum
if [ -e /sbin/md5 ] ; then
	md5 "dtc-"$VERSION".tar.gz" >>$PORT_BUILD/distinfo
	echo "SIZE (dtc-"$VERSION".tar.gz) = "$SIZE >>$PORT_BUILD/distinfo
else
	BSDSUM=`md5sum "dtc-"$VERSION".tar.gz" | cut -f1 -d" "`
	echo "MD5 (dtc-"$VERSION".tar.gz) = "$BSDSUM"
SIZE (dtc-"$VERSION".tar.gz) = "$SIZE >>$PORT_BUILD/distinfo
fi


echo "===> Creating package list file"
echo "-> Calling make install-dtc-common to calculate list"
# Make the pkg-plist file
PKG_PLIST_BUILD=$CURDIR/PKG_PLIST_BUILD
make -C .. install-dtc-common DESTDIR=$PKG_PLIST_BUILD DTC_APP_DIR=/usr/local/www DTC_GEN_DIR=/usr/local/var CONFIG_DIR=/usr/local/etc \
	DTC_DOC_DIR=/usr/local/share/doc MANUAL_DIR=/usr/local/man BIN_DIR=/usr/local/bin UNIX_TYPE=bsd 2>&1 >/dev/null
echo "-> Building list of files"
cd $PKG_PLIST_BUILD
find . -type f | sed "s/\.\/usr\/local/%%LOCALBASE%%/" >$CURDIR/$PORT_BUILD/pkg-plist.tmp
echo "%%LOCALBASE%%/www/dtc/admin/gfx
%%LOCALBASE%%/www/dtc/admin/imgcache
%%LOCALBASE%%/www/dtc/shared/mysql_config.php
%%LOCALBASE%%/www/dtc/client/gfx
%%LOCALBASE%%/www/dtc/client/imgcache
sbin/dtc-install
sbin/dtc-deinstall
%%LOCALBASE%%/dtc/email/gfx
%%LOCALBASE%%/dtc/email/imgcache" >>$CURDIR/$PORT_BUILD/pkg-plist.tmp
find usr/local -type d -printf "@dirrm %h/%f\n" | grep -v "/etc" | sed "s/usr\/local/%%LOCALBASE%%/" | sort -r >>$CURDIR/$PORT_BUILD/pkg-plist.tmp
NBR_LINE=`cat $CURDIR/$PORT_BUILD/pkg-plist.tmp | wc -l`
cat $CURDIR/$PORT_BUILD/pkg-plist.tmp | head -n $(( $NBR_LINE - 2 )) >$CURDIR/$PORT_BUILD/pkg-plist.tmp2
cat $CURDIR/$PORT_BUILD/pkg-plist.tmp2 | grep -v "mysql_config.php" >$CURDIR/$PORT_BUILD/pkg-plist
echo "@dirrm %%DTCROOT%%/etc/zones
@dirrm %%DTCROOT%%/etc
@dirrm %%DTCROOT%%" >>$CURDIR/$PORT_BUILD/pkg-plist
echo "-> Deleting temp files"
rm $CURDIR/$PORT_BUILD/pkg-plist.tmp $CURDIR/$PORT_BUILD/pkg-plist.tmp2
rm -r $PKG_PLIST_BUILD
cd $CURDIR

echo "-> Adding slave ports to the archive"
mkdir -p sysutils/dtc-postfix-courier
cp sources/bsd/dtc-postfix-courier/Makefile sysutils/dtc-postfix-courier
cp sources/bsd/dtc-postfix-courier/pkg-descr sysutils/dtc-postfix-courier
mkdir -p sysutils/dtc-toaster
cp sources/bsd/dtc-toaster/Makefile sysutils/dtc-toaster
cp sources/bsd/dtc-toaster/pkg-descr sysutils/dtc-toaster

# Slave ports for php & proftpd
#mkdir -p lang/php4-dtc
#cp sources/bsd/php4-dtc-slave lang/php4-dtc/Makefile
#mkdir -p ftp/proftpd-mysql
#cp sources/bsd/proftpd-dtc-slave ftp/proftpd-mysql/Makefile

echo "===> Creating .uue archive file"
# Make the file archive
tar -czf "dtcBSDport-"$VERSION".tar.gz" sysutils
uuencode "dtcBSDport-"$VERSION".tar.gz" dtc.tgz >"dtcBSDport-"$VERSION".uue"

echo "===> Creating send-pr file"
cp sources/bsd/sendpr.template sendpr.data
cat "dtcBSDport-"$VERSION".uue" >>sendpr.data
