#!/bin/bash
#
# Welcome to the DTC install maker !
# This will produce the tarball package
# Maintainer: Thomas GOIRAND <thomas@goirand.fr>
# please do not ship with you packages
# this is only a small coder tool...
#

VERS=`cat version`
RELS=`cat release`
VERSION=$VERS"."$RELS
UNIX_TYPE=bsd

echo " --- Making DTC BSD tarball package ---"

# This block should be common to most unix packages :
echo "===> Copying files"
mkdir -p dtc/etc/zones
cp -rf ../admin ../client ../shared ../email ../doc dtc/

# Copy the table dump in the admin directory
if ! [ -f sources/dtc_db.php ]
then
        curdir=`pwd`
	cd sources
	echo "Dumping your DTC SQL structures."
	echo -n "Please enter your mysql password: "
	read conf_dbpass
	php4 backup_db.php $conf_dbpass
	cd $curdir
fi
cp sources/dtc_db.php sources/restor_db.php dtc/admin

kernel=`uname -a | awk '{print $1}'`;

echo "<?php
\$conf_dtc_version= \""$VERS"\";
\$conf_dtc_release= \""$RELS"\";
\$conf_unix_type= \""$UNIX_TYPE"\";
\$conf_kernel_type= \""$kernel"\";
?>" > dtc/shared/dtc_version.php
find dtc/ -iname 'CVS' -exec rm -rf {} \; &>/dev/null
find dtc/ -iname '*~' -exec rm -rf {} \; &>/dev/null
if ! [ -e dtc/admin/gfx ]
then
	ln -s ../shared/gfx dtc/admin/gfx
fi
if ! [ -e dtc/email/gfx ]
then
	ln -s ../shared/gfx dtc/email/gfx
fi
if ! [ -e dtc/client/gfx ]
then
	ln -s ../shared/gfx dtc/client/gfx
fi
if ! [ -e dtc/admin/imgcache ]
then
        ln -s ../shared/imgcache dtc/admin/imgcache
fi
if ! [ -e dtc/client/imgcache ]
then
        ln -s ../shared/imgcache dtc/client/imgcache
fi

chown -R 0:0 dtc
chown -R 65534:65534 dtc/shared dtc/client/imgcache dtc/admin/imgcache dtc/client/gfx dtc/admin/gfx dtc/email/gfx

# Specific BSD package actions :
mkdir "dtc-"$VERSION
mv dtc "dtc-"$VERSION
echo "all:" >"dtc-"$VERSION"/Makefile"
echo "===> Packaging files"
tar -czf "dtc-"$VERSION".tar.gz" "dtc-"$VERSION

echo " --- Succesfully made BSD dtc-"$VERSION".tar.gz ---"
echo " --- Makeing BSD port for version "$VERSION" ---"

# Move bsd version as if it was in ${PREFIX} so we can do lookups in it
mkdir share
mv "dtc-"$VERSION"/dtc" share

echo "===> Creating port files"
# Make  dtc port dir and copy static files in it
mkdir -p dtc/files
cp sources/bsd/pkg-descr dtc
# Create Makefile with correct port version
echo "# Ports collection makefile for:        dtc
# Date created:                 1 December 2003
# Whom:                         Frederic Cambus & Thomas Goirand
#
# \$FreeBSD\$
#

PORTNAME=	dtc
PORTVERSION=	"$VERSION >dtc/Makefile
cat sources/bsd/Makefile >>dtc/Makefile

# Create package install script
cp sources/bsd/install.sh dtc/files/dtc-install.in
cat sources/setup_mysql_db.sh >>dtc/files/dtc-install.in
cat sources/create_chroot.sh >>dtc/files/dtc-install.in
cat sources/configure_deamons.sh >>dtc/files/dtc-install.in
chmod 644 dtc/files/dtc-install.in

# Create package uninstall script
cp sources/bsd/uninstall.sh dtc/files/dtc-deinstall.in
cat sources/uninstall_deamons.sh >>"dtc/files/dtc-deinstall.in"
chmod 644 dtc/files/dtc-deinstall.in

cp sources/bsd/pkg-message dtc

echo "===> Calculating package MD5 sum"
# Make the md5 sum file in this distinfo
BSDSUM=`md5sum "dtc-"$VERSION".tar.gz" | cut -f1 -d" "`
SIZE=`ls -ALln "dtc-"$VERSION".tar.gz" | awk '{print $5}'`
echo "MD5 (dtc-"$VERSION".tar.gz) = "$BSDSUM"
SIZE (dtc-"$VERSION".tar.gz) = "$SIZE >>dtc/distinfo

echo "===> Creating package list file"
# Make the pkg-plist file
find share -type f >dtc/pkg-plist.tmp
echo "share/dtc/admin/gfx
share/dtc/admin/imgcache
share/dtc/shared/mysql_config.php
share/dtc/client/gfx
share/dtc/client/imgcache
sbin/dtc-install
sbin/dtc-deinstall" >>dtc/pkg-plist.tmp
find share -type d -printf "@dirrm %h/%f\n" | grep -v "share/dtc/etc" | sort -r >>dtc/pkg-plist.tmp
NBR_LINE=`cat dtc/pkg-plist.tmp | wc -l`
cat dtc/pkg-plist.tmp | head -n $(($NBR_LINE - 2 )) >dtc/pkg-plist.tmp2
sed "s/share\/dtc/%%DTCROOT%%/" dtc/pkg-plist.tmp2 | grep -v "mysql_config.php" >dtc/pkg-plist
echo "@dirrm %%DTCROOT%%/etc/zones
@dirrm %%DTCROOT%%/etc
@dirrm %%DTCROOT%%" >>dtc/pkg-plist
rm dtc/pkg-plist.tmp dtc/pkg-plist.tmp2

mkdir sysutils
mv dtc sysutils
mkdir -p lang/php4-dtc
cp sources/bsd/php4-dtc-slave lang/php4-dtc/Makefile
mkdir -p ftp/proftpd-mysql
cp sources/bsd/proftpd-dtc-slave ftp/proftpd-mysql/Makefile

echo "===> Creating .uue archive file"
# Make the file archive
tar -czf "dtcBSDport-"$VERSION".tar.gz" lang sysutils ftp
uuencode "dtcBSDport-"$VERSION".tar.gz" dtc.tgz >"dtcBSDport-"$VERSION".uue"

echo "===> Creating send-pr file"
cp sources/bsd/sendpr.template sendpr.data
cat "dtcBSDport-"$VERSION".uue" >>sendpr.data
