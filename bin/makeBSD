#!/bin/bash
#
# Welcome to the DTC install maker !
# This will produce the tarball package
# Maintainer: Thomas GOIRAND <thomas@goirand.fr>
# please do not ship with you packages
# this is only a small coder tool...
#

VERS=`cat version`
RELS=`cat release`
VERSION=$VERS"."$RELS

echo " --- Making DTC BSD tarball package ---"

# This block should be common to most unix packages :
echo "===> Copying files"
mkdir -p dtc/etc/zones
cp -rf ../admin ../client ../shared ../doc dtc/
echo "<?php
\$conf_dtc_version= \""$VERS"\"; \$conf_dtc_release= \""$RELS"\";
?>" > dtc/shared/dtc_version.php
find dtc/ -iname 'CVS' -exec rm -rf {} \; &>/dev/null
find dtc/ -iname '*~' -exec rm -rf {} \; &>/dev/null
if ! [ -e dtc/admin/gfx ]
then
	ln -s ../shared/gfx dtc/admin/gfx
fi
if ! [ -e dtc/client/gfx ]
then
	ln -s ../shared/gfx dtc/client/gfx
fi
if ! [ -e dtc/admin/imgcache ]
then
        ln -s ../shared/imgcache dtc/admin/imgcache
fi
if ! [ -e dtc/client/imgcache ]
then
        ln -s ../shared/imgcache dtc/client/imgcache
fi

chown -R 0:0 dtc
chown -R 65534:65534 dtc/shared dtc/client/imgcache dtc/admin/imgcache dtc/client/gfx dtc/admin/gfx

# Specific BSD package actions :
mkdir "dtc-"$VERSION
mv dtc "dtc-"$VERSION
echo "all:" >"dtc-"$VERSION"/Makefile"
echo "===> Packaging files"
tar -czf "dtc-"$VERSION".tar.gz" "dtc-"$VERSION

echo " --- Succesfully made BSD dtc-"$VERSION".tar.gz ---"
echo " --- Makeing BSD port for version "$VERSION" ---"

# Move bsd version as if it was in ${PREFIX} so we can do lookups in it
mkdir share
mv "dtc-"$VERSION"/dtc" share

# Make  dtc port dir and copy static files in it
mkdir dtc
cp sources/bsd/pkg-descr sources/bsd/README.html dtc
# Create Makefile with correct port version
echo "# Ports collection makefile for:        dtc
# Date created:                 1 December 2003
# Whom:                         Frederic Cambus & Thomas Goirand
#
# $FreeBSD$
#

PORTNAME=	dtc
PORTVERSION=	"$VERSION >dtc/Makefile
cat sources/bsd/Makefile >>dtc/Makefile

# Create package install script
cp sources/bsd/install.sh dtc/pkg-install
cat sources/setup_mysql_db.sh >>dtc/pkg-install
cat sources/configure_deamons.sh >>dtc/pkg-install

# Create package uninstall script
cp sources/bsd/uninstall.sh dtc/pkg-deinstall
cat sources/uninstall_deamons.sh >>"dtc/pkg-deinstall"

# Make the md5 sum file in this distinfo
BSDSUM=`md5sum "dtc-"$VERSION".tar.gz" | cut -f1 -d" "`
echo "MD5 (dtc-"$VERSION".tar.gz) = "$BSDSUM >>dtc/distinfo

# Make the pkg-plist file
find share -type f >dtc/pkg-plist.tmp
echo "share/dtc/admin/gfx
share/dtc/admin/imgcache
share/dtc/client/gfx
share/dtc/client/imgcache" >>dtc/pkg-plist.tmp
find share -type d -printf "@dirrm %h/%f\n" | grep -v "share/dtc/etc" | sort -r >>dtc/pkg-plist.tmp
NBR_LINE=`cat dtc/pkg-plist.tmp | wc -l`
cat dtc/pkg-plist.tmp | head -n $(($NBR_LINE - 2 )) >dtc/pkg-plist
rm dtc/pkg-plist.tmp

# Make the file archive
tar -czf "dtcBSDport-"$VERSION".tar.gz" dtc
rm -rf dtc
uuencode "dtcBSDport-"$VERSION".tar.gz" dtc.tgz >"dtcBSDport-"$VERSION".uue"
